<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>SELECTとINSERT</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/vuetify@3/dist/vuetify.min.css"
    />
  </head>

  <body>
    <!-- Vueで指定された"app"要素 -->
    <div id="app">
      <v-app>
        <v-main>
          <v-container>
            <v-row class="text-h3 mb-3 mt-3" justify="center">
              APIに接続してみよう
            </v-row>

            <v-row class="mb-3 mt-3" align="center" justify="center">
              <v-col cols="4">
                <v-text-field
                  class="ml-6 mr-6"
                  v-model="ID"
                  label="IDを入力"
                  placeholder="IDを入力…"
                  outlined
                ></v-text-field>
              </v-col>

              <v-col cols="6">
                <v-text-field
                  class="ml-6 mr-6"
                  v-model="Name"
                  label="Nameを入力"
                  placeholder="Nameを入力…"
                  outlined
                ></v-text-field>
              </v-col>
            </v-row>

            <v-row class="mb-3 mt-3" align="center" justify="center">
              入力内容　ID: {{ ID }} Name: {{ Name }}
              <v-btn @click="addData" dark small color="indigo" class="ml-4">
                DBに登録
              </v-btn>
            </v-row>

            <v-row class="mb-3 mt-3" justify="center">
              <v-btn @click="readData" rounded>現在の登録内容を表示する</v-btn>
            </v-row>

            <v-row
              v-for="(data, index) in dataList"
              :key="index"
              class="mb-2"
              justify="center"
            >
              ID: {{ data.ID }}, Name: {{ data.Name }}
            </v-row>

            <!-- セッション確認関連UIを追加 -->
            <v-row class="mb-3 mt-3" justify="center">
              <v-btn @click="checkSession" color="primary"
                >セッションをチェック</v-btn
              >
            </v-row>

            <v-snackbar v-model="snackbar" :timeout="3000">
              {{ snackbarMessage }}
            </v-snackbar>

            <v-dialog v-model="dialog" max-width="400">
              <v-card>
                <v-card-title class="headline">セッションが無効です</v-card-title>
                <v-card-text>{{ dialogMessage }}</v-card-text>
                <v-card-actions>
                  <v-spacer></v-spacer>
                  <v-btn color="primary" text @click="redirectToLogin">OK</v-btn>
                </v-card-actions>
              </v-card>
            </v-dialog>
          </v-container>
        </v-main>
      </v-app>
    </div>

    <!-- Vue / Vuetify / Axios -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3/dist/vuetify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
      const { createApp, ref } = Vue;
      const { createVuetify } = Vuetify;

      const vuetify = createVuetify();

      const app = createApp({
        setup() {
          const ID = ref("");
          const Name = ref("");
          const dataList = ref([]);

          // --- セッション管理用 ---
          const snackbar = ref(false);
          const snackbarMessage = ref("");
          const dialog = ref(false);
          const dialogMessage = ref("");

          // --- データ登録処理 ---
          const addData = async () => {
            try {
              const response = await axios.post(
                "https://m3h-ookawa-containerapps-vnet.gentlerock-32477362.japaneast.azurecontainerapps.io/api/INSERT",
                { ID: ID.value, Name: Name.value }
              );
              console.log("INSERT結果:", response.data);
              snackbarMessage.value = "登録が完了しました。";
              snackbar.value = true;
            } catch (err) {
              console.error("登録エラー:", err);
              dialogMessage.value = "登録中にエラーが発生しました。";
              dialog.value = true;
            }
          };

          // --- データ取得処理 ---
          const readData = async () => {
            try {
              const response = await axios.get(
                "https://m3h-ookawa-containerapps-vnet.gentlerock-32477362.japaneast.azurecontainerapps.io/api/SELECT"
              );
              dataList.value = response.data;
              console.log("SELECT結果:", dataList.value);
            } catch (err) {
              console.error("SELECTエラー:", err);
              dialogMessage.value = "データ取得中にエラーが発生しました。";
              dialog.value = true;
            }
          };

          // --- セッションチェック処理 ---
          const checkSession = async () => {
            try {
              // CookieからセッションIDを取得
              const cookies = document.cookie.split("; ");
              const sessionCookie = cookies.find((c) =>
                c.startsWith("session_id=")
              );
              const sessionId = sessionCookie
                ? sessionCookie.split("=")[1]
                : null;

              if (!sessionId) {
                dialogMessage.value = "セッションIDが見つかりません。";
                dialog.value = true;
                return;
              }

              // セッション有効性チェックAPI呼び出し
              const response = await axios.post(
                "https://m3h-ookawa-containerapps-vnet.gentlerock-32477362.japaneast.azurecontainerapps.io/api/CHECKSESSION",
                { SessionId: sessionId }
              );

              console.log("セッションチェック結果:", response.data);

              if (response.data?.status === "Success") {
                snackbarMessage.value = "セッションは有効です！";
                snackbar.value = true;
              } else {
                dialogMessage.value =
                  response.data?.message || "セッションが無効です。";
                dialog.value = true;
              }
            } catch (err) {
              console.error("セッションチェックエラー:", err);
              dialogMessage.value = "通信エラーが発生しました。";
              dialog.value = true;
            }
          };

          // --- ログイン画面へ戻す処理 ---
          const redirectToLogin = () => {
            window.location.href = "login.html";
          };

          return {
            ID,
            Name,
            dataList,
            addData,
            readData,
            snackbar,
            snackbarMessage,
            dialog,
            dialogMessage,
            checkSession,
            redirectToLogin,
          };
        },
      });

      app.use(vuetify);
      app.mount("#app");
    </script>
  </body>
</html>
